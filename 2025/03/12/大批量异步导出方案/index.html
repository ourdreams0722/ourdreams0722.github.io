<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="不易">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
            <link rel="preconnect" href="https://evan.beee.top" crossorigin>
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2025/03/12/大批量异步导出方案/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:type" content="article">
<meta property="og:title" content="Java基础POI的异步导出">
<meta property="og:url" content="http://example.com/2025/03/12/%E5%A4%A7%E6%89%B9%E9%87%8F%E5%BC%82%E6%AD%A5%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="ourdreams">
<meta property="og:description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/redefine-og.webp">
<meta property="article:published_time" content="2025-03-12T14:07:05.000Z">
<meta property="article:modified_time" content="2025-03-27T08:17:59.383Z">
<meta property="article:author" content="不易">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/redefine-og.webp">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            Java基础POI的异步导出 | ourdreams
        
    </title>

    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/css/build/tailwind.css">
    

    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fonts/GeistMono/geist-mono.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fonts/Geist/geist.css">
    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":["不全的全栈"]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":{"enable":true,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Easy to know, easy to be ignorant","subtitle":{"text":["Easier said than done."],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":false,"smart_backspace":false},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"11.4.1"}},"version":"2.8.2","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2025/3/12 11:45:14"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                ourdreams
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">28</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">9</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">46</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Java基础POI的异步导出</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/redefine-avatar.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">不易</span>
					
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">不全的全栈</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-03-12 22:07:05</span>
        <span class="mobile">2025-03-12 22:07:05</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-03-27 16:17:59</span>
            <span class="mobile">2025-03-27 16:17:59</span>
            <span class="hover-info">更新</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<ul>
<li>简单思路</li>
</ul>
<blockquote>
<p>获取数据总量，分块读取写入，多线程操作(缓存保证一致性)，数据只持留一部分在内存，其余刷进磁盘<br>用户发起导出指令后建立异步任务，前端要么通过全局通知&#x2F;SOCKET等要么随便刷新等来刷任务执行进度<br>文件持久在一个共享目录，OSS或者本地都可<br>清理方案：</p>
<blockquote>
<p>持久记录SQL与文件映射,超期清理</p>
<p>直接暴力定读整体目录超期清理<br>用户下载完文件后直接清理</p>
</blockquote>
</blockquote>
<ul>
<li>实现</li>
</ul>
<h4 id="1-获取导出语句的数据总量"><a href="#1-获取导出语句的数据总量" class="headerlink" title="1. 获取导出语句的数据总量"></a>1. 获取导出语句的数据总量</h4><h5 id="1-1-获取MAPPER的执行SQL"><a href="#1-1-获取MAPPER的执行SQL" class="headerlink" title="1.1 获取MAPPER的执行SQL"></a>1.1 获取MAPPER的执行SQL</h5><p>编写工具包</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.mybatis.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.xxx.eum.CodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.xxx.exception.RunException;</span><br><span class="line"><span class="keyword">import</span> com.xxx.util.DateUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ParameterMapping;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ParameterMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SQL额外工具包</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * XXX map = new XXX();</span></span><br><span class="line"><span class="comment">     * xxx.setId(1L);</span></span><br><span class="line"><span class="comment">     * execute(XxxMapper.class.getName().concat(&quot;.getXXXmethod&quot;), map, sqlSessionFactory)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 获取可执行SQL</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sqlId mapper sql id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 参数对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sqlSessionFactory sql session 工厂</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SQL语句</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">execute</span><span class="params">(String sqlId, Object object, SqlSessionFactory sqlSessionFactory)</span> &#123;</span><br><span class="line">        <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> sqlSessionFactory.getConfiguration().getMappedStatement(sqlId).getBoundSql(object);</span><br><span class="line">        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line">        Map&lt;?, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">BeanMap</span>(object);<span class="comment">// 它是个数组 要拆分处理</span></span><br><span class="line">        List&lt;Object&gt; paramValues = getParamValues(paramMap, parameterMappings, boundSql);</span><br><span class="line">        <span class="type">String</span> <span class="variable">execSql</span> <span class="operator">=</span> getExecuteSql(sql, paramValues);</span><br><span class="line">        <span class="keyword">return</span> execSql.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;[ ]+&quot;</span>,<span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置查询参数值，返回可直接执行的sql</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sql SQL语句</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramValues 参数列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SQL语句</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getExecuteSql</span><span class="params">(String sql, List&lt;Object&gt; paramValues)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (sql.contains(<span class="string">&quot;?&quot;</span>) &amp;&amp; paramValues != <span class="literal">null</span> &amp;&amp; paramValues.size() &gt; <span class="number">0</span> &amp;&amp; paramValues.get(<span class="number">0</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">paramValue</span> <span class="operator">=</span> paramValues.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (paramValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> paramValue.toString();</span><br><span class="line">                <span class="keyword">if</span> (paramValue <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    value = <span class="string">&quot;&#x27;&quot;</span> + paramValue + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramValue <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">                    value = DateUtils.parseDateToStr(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, (Date) paramValue);</span><br><span class="line">                    value = <span class="string">&quot;str_to_date(&#x27;&quot;</span> + value + <span class="string">&quot;&#x27;,&#x27;%Y-%m-%d %T&#x27;)&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, value);</span><br><span class="line">                paramValues.remove(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据动态查询条件获取查询参数值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Object&gt; <span class="title function_">getParamValues</span><span class="params">(Map&lt;?, Object&gt; paramMap,</span></span><br><span class="line"><span class="params">                                               List&lt;ParameterMapping&gt; parameterMappings, BoundSql boundSql)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (parameterMappings == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Object&gt; paramValues = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ParameterMapping pm : parameterMappings) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pm.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">paramName</span> <span class="operator">=</span> pm.getProperty();</span><br><span class="line">                <span class="type">Object</span> <span class="variable">paramValue</span> <span class="operator">=</span> getVal(paramMap, paramName);</span><br><span class="line">                <span class="keyword">if</span> (paramValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果正常的递归数据集中找不到映射参数 就去Bound的额外生成参数中寻找映射</span></span><br><span class="line">                    paramValue = boundSql.getAdditionalParameter(paramName);</span><br><span class="line">                &#125;</span><br><span class="line">                paramValues.add(paramValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> paramValues;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getVal</span><span class="params">(Map&lt;?, Object&gt; paramMap, String paramName)</span>&#123;</span><br><span class="line">        String[] strArr = paramName.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> getVal(paramMap, strArr, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getVal</span><span class="params">(Map&lt;?, Object&gt; paramMap, String[] paramName, <span class="type">int</span> index)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> paramName[index];</span><br><span class="line">        <span class="keyword">if</span> (index == paramName.length-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;]&quot;</span>.equals(key.substring(key.length()-<span class="number">1</span>))) &#123;</span><br><span class="line">                String[] arr = key.substring(<span class="number">0</span>, key.length()-<span class="number">1</span>).split(<span class="string">&quot;\\[&quot;</span>);</span><br><span class="line">                key = arr[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">return</span> (JSON.parseObject(JSONObject.toJSONString(paramMap.get(key)), List.class)).get(Integer.parseInt(arr[<span class="number">1</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> paramMap.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">        index++;</span><br><span class="line">        paramMap = JSON.parseObject(JSONObject.toJSONString(paramMap.get(key)), Map.class);</span><br><span class="line">        <span class="keyword">return</span> getVal(paramMap, paramName, index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">(String sql, SqlSessionFactory sqlSessionFactory)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> sql.indexOf(<span class="string">&quot; FROM&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (idx == -<span class="number">1</span>)&#123;</span><br><span class="line">            idx = sql.indexOf(<span class="string">&quot; from&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sql = <span class="string">&quot;SELECT COUNT(1)&quot;</span>.concat(sql.substring(idx));</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> sqlSessionFactory.openSession().getConnection();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> statement.executeQuery(sql);</span><br><span class="line">            rs.next();</span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> rs.getInt(<span class="string">&quot;COUNT(1)&quot;</span>);</span><br><span class="line">            connection.close();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RunExceptionCodeEnum</span>.SERVER_ERROR.getCode(), <span class="string">&quot;获取数据总量失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="1-2-获取SQL与数据总量"><a href="#1-2-获取SQL与数据总量" class="headerlink" title="1.2 获取SQL与数据总量"></a>1.2 获取SQL与数据总量</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// XxxMapper为你的实际MAPPER接口</span></span><br><span class="line"><span class="comment">// method为MAPPER内对应方法</span></span><br><span class="line"><span class="comment">// body为传入执行方法的SQL参数,因为要借助BeanMap来转换映射所以此处的body只能为一个实体对象CLASS而非一个数据结构/类型(MAP,LIST)</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> SqlUtils.execute(XxxMapper.class.getName().concat(<span class="string">&quot;.method&quot;</span>), body, sqlSessionFactory);</span><br><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> SqlUtils.getCount(sql, sqlSessionFactory);</span><br></pre></td></tr></table></figure></div>

<h4 id="2-建立导出工具包"><a href="#2-建立导出工具包" class="headerlink" title="2. 建立导出工具包"></a>2. 建立导出工具包</h4><p>还是依赖于poi包，引入其依赖使用高版本的SXSSF即可</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxx.annotation.Excel;</span><br><span class="line"><span class="keyword">import</span> com.xxx.annotation.Excels;</span><br><span class="line"><span class="keyword">import</span> com.xxx.constant.SysConfigurationConsts;</span><br><span class="line"><span class="keyword">import</span> com.xxx.eum.CodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.xxx.exception.RunException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFFont;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.util.HSSFColor;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.util.CellRangeAddressList;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFDataValidation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 导出工具包</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelExportUtil</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实体对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;T&gt; clazz;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注解列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Field&gt; fields;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SXSSFWorkbook book;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelExportUtil</span><span class="params">(Class&lt;T&gt; clazz, String dir, String moduleName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.clazz = clazz;</span><br><span class="line">        <span class="built_in">this</span>.buildExcelField();</span><br><span class="line">        <span class="built_in">this</span>.buildWorkBook();</span><br><span class="line">        <span class="built_in">this</span>.fileName = encodingFilename(moduleName);</span><br><span class="line">        <span class="built_in">this</span>.filePath = getAbsoluteFile(dir, fileName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编码文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encodingFilename</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        filename = filename + <span class="string">&quot;-&quot;</span> + DateUtils.dateTimeNow() + <span class="string">&quot;.xlsx&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回预期文件名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取下载路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename 文件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAbsoluteFile</span><span class="params">(String filePath, String filename)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">downloadPath</span> <span class="operator">=</span> filePath + filename;</span><br><span class="line">        <span class="type">File</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(downloadPath);</span><br><span class="line">        <span class="keyword">if</span> (!desc.getParentFile().exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!desc.getParentFile().mkdirs()) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;建立存储Excel目录失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> downloadPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildWorkBook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.book = <span class="keyword">new</span> <span class="title class_">SXSSFWorkbook</span>(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SXSSFSheet <span class="title function_">buildSheet</span><span class="params">(<span class="type">int</span> start)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> book.createSheet(((start * SysConfigurationConsts.MAX_EXPORT_COUNT)+<span class="number">1</span>)+<span class="string">&quot;-&quot;</span>+((start+<span class="number">1</span>)* SysConfigurationConsts.MAX_EXPORT_COUNT));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">make</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath);</span><br><span class="line">            book.write(out);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;EXCEL文件生成失败:&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RunException</span>(CodeEnum.FAIL.getCode(), <span class="string">&quot;EXCEL文件生成失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (book != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    book.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;EXCEL对象资源关闭失败:&#123;&#125;&quot;</span>,fileName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;EXCEL文件资源关闭失败:&#123;&#125;&quot;</span>,fileName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(List&lt;T&gt; list, SXSSFSheet sheet)</span> &#123;</span><br><span class="line">        <span class="comment">// 标题行</span></span><br><span class="line">        <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">excelsNo</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 写入各个字段的列头名称</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">column</span> <span class="operator">=</span> <span class="number">0</span>; column &lt; fields.size(); column++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fields.get(column);</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excel.class)) &#123;</span><br><span class="line">                <span class="type">Excel</span> <span class="variable">excel</span> <span class="operator">=</span> field.getAnnotation(Excel.class);</span><br><span class="line">                createCell(sheet, excel, row, column);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excels.class)) &#123;</span><br><span class="line">                <span class="type">Excels</span> <span class="variable">attrs</span> <span class="operator">=</span> field.getAnnotation(Excels.class);</span><br><span class="line">                Excel[] excels = attrs.value();</span><br><span class="line">                <span class="comment">// 写入列名</span></span><br><span class="line">                <span class="type">Excel</span> <span class="variable">excel</span> <span class="operator">=</span> excels[excelsNo++];</span><br><span class="line">                createCell(sheet, excel, row, column);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">cs</span> <span class="operator">=</span> book.createCellStyle();</span><br><span class="line">        cs.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        cs.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">            excelsNo = <span class="number">0</span>;</span><br><span class="line">            row = sheet.createRow(i + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">column</span> <span class="operator">=</span> <span class="number">0</span>; column &lt; fields.size(); column++) &#123;</span><br><span class="line">                <span class="comment">// 获得field.</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fields.get(column);</span><br><span class="line">                <span class="comment">// 设置实体类私有属性可访问</span></span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (field.isAnnotationPresent(Excel.class)) &#123;</span><br><span class="line">                    addCell(field.getAnnotation(Excel.class), row, list.get(i), field, column, cs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (field.isAnnotationPresent(Excels.class)) &#123;</span><br><span class="line">                    <span class="type">Excels</span> <span class="variable">attrs</span> <span class="operator">=</span> field.getAnnotation(Excels.class);</span><br><span class="line">                    Excel[] excels = attrs.value();</span><br><span class="line">                    <span class="type">Excel</span> <span class="variable">excel</span> <span class="operator">=</span> excels[excelsNo++];</span><br><span class="line">                    addCell(excel, row, list.get(i), field, column, cs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildExcelField</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;Field&gt; fields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Field&gt; tempFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        tempFields.addAll(Arrays.asList(clazz.getSuperclass().getDeclaredFields()));</span><br><span class="line">        tempFields.addAll(Arrays.asList(clazz.getDeclaredFields()));</span><br><span class="line">        <span class="keyword">for</span> (Field field : tempFields) &#123;</span><br><span class="line">            <span class="comment">// 单注解</span></span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excel.class)) &#123;</span><br><span class="line">                <span class="type">Excel</span> <span class="variable">attr</span> <span class="operator">=</span> field.getAnnotation(Excel.class);</span><br><span class="line">                <span class="keyword">if</span> (attr != <span class="literal">null</span> &amp;&amp; (attr.type() == Excel.Type.ALL || attr.type() == Excel.Type.EXPORT)) &#123;</span><br><span class="line">                    fields.add(field);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 多注解</span></span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excels.class)) &#123;</span><br><span class="line">                <span class="type">Excels</span> <span class="variable">attrs</span> <span class="operator">=</span> field.getAnnotation(Excels.class);</span><br><span class="line">                Excel[] excels = attrs.value();</span><br><span class="line">                <span class="keyword">for</span> (Excel excel : excels) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (excel != <span class="literal">null</span> &amp;&amp; (excel.type() == Excel.Type.ALL || excel.type() == Excel.Type.EXPORT)) &#123;</span><br><span class="line">                        fields.add(field);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.fields = fields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加单元格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCell</span><span class="params">(Excel attr, Row row, T vo, Field field, <span class="type">int</span> column, CellStyle cs)</span> &#123;</span><br><span class="line">        Cell cell;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置行高</span></span><br><span class="line">            row.setHeight((<span class="type">short</span>) (attr.height() * <span class="number">20</span>));</span><br><span class="line">            <span class="comment">// 根据Excel中设置情况决定是否导出,有些情况需要保持为空,希望用户填写这一列.</span></span><br><span class="line">            <span class="keyword">if</span> (attr.isExport()) &#123;</span><br><span class="line">                <span class="comment">// 创建cell</span></span><br><span class="line">                cell = row.createCell(column);</span><br><span class="line">                cell.setCellStyle(cs);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 用于读取对象中的属性</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getTargetValue(vo, field, attr);</span><br><span class="line">                <span class="type">String</span> <span class="variable">dateFormat</span> <span class="operator">=</span> attr.dateFormat();</span><br><span class="line">                <span class="type">String</span> <span class="variable">readConverterExp</span> <span class="operator">=</span> attr.readConverterExp();</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isDecimalFormat</span> <span class="operator">=</span> attr.isDecimalFormat();</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(dateFormat) &amp;&amp; value != <span class="literal">null</span>) &#123;</span><br><span class="line">                    cell.setCellValue(DateUtils.parseDateToStr(dateFormat, (Date) value));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(readConverterExp) &amp;&amp; value != <span class="literal">null</span>) &#123;</span><br><span class="line">                    cell.setCellValue(convertByExp(String.valueOf(value), readConverterExp));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDecimalFormat) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        cell.setCellValue(<span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cell.setCellValue((<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(value.toString())).stripTrailingZeros().toPlainString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cell.setCellType(CellType.STRING);</span><br><span class="line">                    <span class="comment">// 如果数据存在就填入,不存在填入空格.</span></span><br><span class="line">                    cell.setCellValue(value == <span class="literal">null</span> ? attr.defaultValue() : value + attr.suffix());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;导出Excel失败&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取bean中的属性值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vo    实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field 字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> excel 注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 最终的属性值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getTargetValue</span><span class="params">(T vo, Field field, Excel excel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> field.get(vo);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(excel.targetAttr())) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> excel.targetAttr();</span><br><span class="line">            <span class="keyword">if</span> (target.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">                String[] targets = target.split(<span class="string">&quot;[.]&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String name : targets) &#123;</span><br><span class="line">                    o = getValue(o, name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                o = getValue(o, target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析导出值 0=男,1=女,2=未知</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> propertyValue 参数值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> converterExp  翻译注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解析后值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">convertByExp</span><span class="params">(String propertyValue, String converterExp)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] convertSource = converterExp.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String item : convertSource) &#123;</span><br><span class="line">                String[] itemArray = item.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (itemArray[<span class="number">0</span>].equals(propertyValue)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> itemArray[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> propertyValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以类的属性的get方法方法形式获取值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o 属性对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 属性名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getValue</span><span class="params">(Object o, String name)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(name)) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = o.getClass();</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;get&quot;</span> + name.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + name.substring(<span class="number">1</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(methodName);</span><br><span class="line">            o = method.invoke(o);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建单元格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCell</span><span class="params">(Sheet sheet, Excel attr, Row row, <span class="type">int</span> column)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建列</span></span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> row.createCell(column);</span><br><span class="line">        <span class="comment">// 设置列中写入内容为String类型</span></span><br><span class="line">        cell.setCellType(CellType.STRING);</span><br><span class="line">        <span class="comment">// 写入列名</span></span><br><span class="line">        cell.setCellValue(attr.name());</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">cellStyle</span> <span class="operator">=</span> createStyle(sheet, attr, row, column);</span><br><span class="line">        cell.setCellStyle(cellStyle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建表格样式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CellStyle <span class="title function_">createStyle</span><span class="params">(Sheet sheet, Excel attr, Row row, <span class="type">int</span> column)</span> &#123;</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">cellStyle</span> <span class="operator">=</span> book.createCellStyle();</span><br><span class="line">        cellStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        cellStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> book.createFont();</span><br><span class="line">        <span class="keyword">if</span> (attr.name().contains(<span class="string">&quot;注：&quot;</span>)) &#123;</span><br><span class="line">            font.setColor(HSSFFont.COLOR_RED);</span><br><span class="line">            cellStyle.setFont(font);</span><br><span class="line">            cellStyle.setFillForegroundColor(HSSFColor.HSSFColorPredefined.YELLOW.getIndex());</span><br><span class="line">            sheet.setColumnWidth(column, <span class="number">6000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 粗体显示</span></span><br><span class="line">            font.setBold(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 选择需要用到的字体格式</span></span><br><span class="line">            cellStyle.setFont(font);</span><br><span class="line">            cellStyle.setFillForegroundColor(HSSFColor.HSSFColorPredefined.LIGHT_YELLOW.getIndex());</span><br><span class="line">            <span class="comment">// 设置列宽</span></span><br><span class="line">            sheet.setColumnWidth(column, (<span class="type">int</span>) ((attr.width() + <span class="number">0.72</span>) * <span class="number">256</span>));</span><br><span class="line">            row.setHeight((<span class="type">short</span>) (attr.height() * <span class="number">20</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">        cellStyle.setWrapText(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 如果设置了提示信息则鼠标放上去提示.</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(attr.prompt())) &#123;</span><br><span class="line">            <span class="comment">// 这里默认设了2-101列提示.</span></span><br><span class="line">            setXSSFPrompt(sheet, <span class="string">&quot;&quot;</span>, attr.prompt(), <span class="number">1</span>, <span class="number">100</span>, column, column);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果设置了combo属性则本列只能选择不能输入</span></span><br><span class="line">        <span class="keyword">if</span> (attr.combo().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里默认设了2-101列只能选择不能输入.</span></span><br><span class="line">            setXSSFValidation(sheet, attr.combo(), <span class="number">1</span>, <span class="number">100</span>, column, column);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cellStyle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置 POI XSSFSheet 单元格提示</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheet         表单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promptTitle   提示标题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promptContent 提示内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstRow      开始行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endRow        结束行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstCol      开始列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endCol        结束列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setXSSFPrompt</span><span class="params">(Sheet sheet, String promptTitle, String promptContent, <span class="type">int</span> firstRow, <span class="type">int</span> endRow,</span></span><br><span class="line"><span class="params">                              <span class="type">int</span> firstCol, <span class="type">int</span> endCol)</span> &#123;</span><br><span class="line">        <span class="type">DataValidationHelper</span> <span class="variable">helper</span> <span class="operator">=</span> sheet.getDataValidationHelper();</span><br><span class="line">        <span class="type">DataValidationConstraint</span> <span class="variable">constraint</span> <span class="operator">=</span> helper.createCustomConstraint(<span class="string">&quot;DD1&quot;</span>);</span><br><span class="line">        <span class="type">CellRangeAddressList</span> <span class="variable">regions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CellRangeAddressList</span>(firstRow, endRow, firstCol, endCol);</span><br><span class="line">        <span class="type">DataValidation</span> <span class="variable">dataValidation</span> <span class="operator">=</span> helper.createValidation(constraint, regions);</span><br><span class="line">        dataValidation.createPromptBox(promptTitle, promptContent);</span><br><span class="line">        dataValidation.setShowPromptBox(<span class="literal">true</span>);</span><br><span class="line">        sheet.addValidationData(dataValidation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置某些列的值只能输入预制的数据,显示下拉框.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheet    要设置的sheet.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textlist 下拉框显示的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstRow 开始行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endRow   结束行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstCol 开始列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endCol   结束列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 设置好的sheet.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setXSSFValidation</span><span class="params">(Sheet sheet, String[] textlist, <span class="type">int</span> firstRow, <span class="type">int</span> endRow, <span class="type">int</span> firstCol, <span class="type">int</span> endCol)</span> &#123;</span><br><span class="line">        <span class="type">DataValidationHelper</span> <span class="variable">helper</span> <span class="operator">=</span> sheet.getDataValidationHelper();</span><br><span class="line">        <span class="comment">// 加载下拉列表内容</span></span><br><span class="line">        <span class="type">DataValidationConstraint</span> <span class="variable">constraint</span> <span class="operator">=</span> helper.createExplicitListConstraint(textlist);</span><br><span class="line">        <span class="comment">// 设置数据有效性加载在哪个单元格上,四个参数分别是：起始行、终止行、起始列、终止列</span></span><br><span class="line">        <span class="type">CellRangeAddressList</span> <span class="variable">regions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CellRangeAddressList</span>(firstRow, endRow, firstCol, endCol);</span><br><span class="line">        <span class="comment">// 数据有效性对象</span></span><br><span class="line">        <span class="type">DataValidation</span> <span class="variable">dataValidation</span> <span class="operator">=</span> helper.createValidation(constraint, regions);</span><br><span class="line">        <span class="comment">// 处理Excel兼容性问题</span></span><br><span class="line">        <span class="keyword">if</span> (dataValidation <span class="keyword">instanceof</span> XSSFDataValidation) &#123;</span><br><span class="line">            dataValidation.setSuppressDropDownArrow(<span class="literal">true</span>);</span><br><span class="line">            dataValidation.setShowErrorBox(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dataValidation.setSuppressDropDownArrow(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sheet.addValidationData(dataValidation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>相关的自定义小注解与工具类就不贴出了，都是最简单实现，网上一大片</p>
</blockquote>
<h4 id="3-建立任务缓存监听器"><a href="#3-建立任务缓存监听器" class="headerlink" title="3. 建立任务缓存监听器"></a>3. 建立任务缓存监听器</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.redis.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxx.redis.service.RedisService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Excel相关的任务缓存工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelTaskUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">EXPIRE</span> <span class="operator">=</span> <span class="number">86500</span>;<span class="comment">// 过期时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * REDIS缓存KEY值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> KEY值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">USER_EXPORT_TASK</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user:export:task:&quot;</span>.concat(String.valueOf(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个文件缓存任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisService 缓存服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> countGroup 最大执行总量组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addExportFile</span><span class="params">(RedisService redisService, String fileName, Long id, <span class="type">int</span> countGroup)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(id);</span><br><span class="line">        <span class="keyword">if</span> (!redisService.hasKey(key)) &#123;</span><br><span class="line">            redisService.hSetAll(key, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 文件一天过期，缓存信息一天过期 不过期也会被系统清理</span></span><br><span class="line">        redisService.hSet(key, fileName, <span class="string">&quot;0/&quot;</span>.concat(String.valueOf(countGroup)), EXPIRE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行计划导出文件/片段执行结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisService 缓存服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 任务是否全部执行完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">scheduleExportFile</span><span class="params">(RedisService redisService, String fileName, Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(id);</span><br><span class="line">        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> (String)redisService.hGet(key, fileName);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="literal">null</span>) &#123;</span><br><span class="line">            String[] arr = val.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> Integer.parseInt(arr[<span class="number">0</span>])+<span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> Integer.parseInt(arr[<span class="number">1</span>]);</span><br><span class="line">            redisService.hSet(key, fileName, current+<span class="string">&quot;/&quot;</span>+count, EXPIRE);</span><br><span class="line">            <span class="keyword">return</span> current &gt;= count;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户下全部导出任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisService 缓存服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 任务列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Object, Object&gt; <span class="title function_">getExportTask</span><span class="params">(RedisService redisService, Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(id);</span><br><span class="line">        <span class="keyword">if</span> (!redisService.hasKey(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisService.hGetAll(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证任务是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisService 缓存服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 验证结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verifyTaskExist</span><span class="params">(RedisService redisService, String fileName, Long userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(userId);</span><br><span class="line">        <span class="keyword">return</span> redisService.hasKey(key) &amp;&amp; redisService.hHasKey(key, fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeCache</span><span class="params">(RedisService redisService, String fileName, Long userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(userId);</span><br><span class="line">        redisService.hDel(key, fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="4-联合两个工具包自定义导出"><a href="#4-联合两个工具包自定义导出" class="headerlink" title="4. 联合两个工具包自定义导出"></a>4. 联合两个工具包自定义导出</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  线程池对象，springframework会存在默认实现，一般以你服务器CPU性能来分配默认参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolTaskExecutor poolTaskExecutor;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 导出记录</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> count 数据总量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> body 请求参数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportRecord</span><span class="params">(<span class="type">int</span> count, BasePageBody body)</span> &#123;</span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> AuthContext.getUser().getId();<span class="comment">// 配合GATEWAY分发注入的全局上下文用户信息 存储在ThreadLocal</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">group</span> <span class="operator">=</span> (<span class="type">int</span>)Math.ceil(count/ (<span class="type">double</span>) SysConfigurationConsts.MAX_EXPORT_COUNT);<span class="comment">// 获取分组</span></span><br><span class="line">       ExcelExportUtil&lt;Clazz&gt; exportUtil = <span class="keyword">new</span> <span class="title class_">ExcelExportUtil</span>&lt;&gt;(Clazz.class,</span><br><span class="line">               SysConfigurationConsts.PUBLIC_EXPORT_DIR, <span class="string">&quot;xxx记录&quot;</span>);<span class="comment">// 实体类对象(用以反射取属性),导出文件存储目录(分布式但集中存储,LINUX挂软链，OSS更简单),文件功能名</span></span><br><span class="line">       <span class="comment">// 建立异步任务轨迹</span></span><br><span class="line">       ExcelTaskUtil.addExportFile(redisService, exportUtil.getFileName(), userId, group);</span><br><span class="line">       <span class="comment">// 我一般采用一个公共参数对象，设定一个LIMIT来手动分页，此处不要使用mybatis分页器</span></span><br><span class="line">       body.setLimit(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Integer&gt;(<span class="number">2</span>)&#123;&#123;</span><br><span class="line">           put(<span class="string">&quot;start&quot;</span>, <span class="number">0</span>);</span><br><span class="line">           put(<span class="string">&quot;end&quot;</span>, SysConfigurationConsts.MAX_EXPORT_COUNT);</span><br><span class="line">       &#125;&#125;);</span><br><span class="line">       <span class="comment">// 启异步线程，取决业务，此处为非频繁操作，客户端也会限制，所以使用默认全量线程参数</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; group; i++) &#123;</span><br><span class="line">           <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">           poolTaskExecutor.execute(() -&gt; &#123;</span><br><span class="line">               <span class="keyword">try</span>&#123;</span><br><span class="line">                   body.getLimit().put(<span class="string">&quot;start&quot;</span>, SysConfigurationConsts.MAX_EXPORT_COUNT * finalI);</span><br><span class="line">                   <span class="comment">// 获取实体数据</span></span><br><span class="line">                   List&lt;Clazz&gt; list = service.xxxmethod(body.getParams(), body.getLimit());</span><br><span class="line">                   <span class="comment">// 构建工作页刷进磁盘,此时才去根据循环节点来构建工作页，防止乱序</span></span><br><span class="line">                   exportUtil.build(list, exportUtil.buildSheet(finalI));</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   log.error(<span class="string">&quot;线程池异常：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   <span class="comment">// 无论子线程任务是否完成都要刷文件执行进度，哪怕损坏文件也不要将任务挂起</span></span><br><span class="line">                   <span class="keyword">if</span> (ExcelTaskUtil.scheduleExportFile(redisService, exportUtil.getFileName(), userId)) &#123;</span><br><span class="line">                       <span class="comment">// 留任务结束后的自定义操作空间 不必切片切入所以手动make文件</span></span><br><span class="line">                       exportUtil.make();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="5-查询与下载"><a href="#5-查询与下载" class="headerlink" title="5. 查询与下载"></a>5. 查询与下载</h4><blockquote>
<p>挂全局公共接口即可，类全局通知</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;查询所有待办任务&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;task&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultsVO&lt;Map&lt;String, String&gt;&gt; <span class="title function_">task</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ResultsVO.success(ExcelTaskUtil.getExportTask(redisService, AuthContext.getUser().getId()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;下载文件&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;download&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">download</span><span class="params">(<span class="meta">@RequestParam(&quot;fileName&quot;)</span> String filename, HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ExcelTaskUtil.verifyTaskExist(redisService, filename, AuthContext.getUser().getId())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RunException</span>(CodeEnum.SERVER_ERROR.getCode(), <span class="string">&quot;任务已过期&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> SysConfigurationConsts.PUBLIC_EXPORT_DIR + filename;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="title class_">File</span>(filePath).exists()) &#123;</span><br><span class="line">        ExcelTaskUtil.removeCache(redisService, filename, AuthContext.getUser().getId());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RunException</span>(CodeEnum.SERVER_ERROR.getCode(), <span class="string">&quot;文件已被清理&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response.setHeader(<span class="string">&quot;requestType&quot;</span>,<span class="string">&quot;file&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>,<span class="string">&quot;requestType&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePrefixName</span> <span class="operator">=</span> FileUtils.getFilePrefixName(filename);</span><br><span class="line">        ExcelUtil.compatibleFileName(request, response, filePrefixName);</span><br><span class="line">        FileUtils.writeBytes(filePath, response.getOutputStream());</span><br><span class="line">        <span class="comment">//FileUtils.deleteFile(filePath);</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RunException</span>(CodeEnum.SERVER_ERROR.getCode(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-清理策略"><a href="#6-清理策略" class="headerlink" title="6. 清理策略"></a>6. 清理策略</h4><blockquote>
<p>考虑到业务量并不大，简单的每天定时清理即可</p>
<p>此方式应只做为补偿逻辑的一种而非主清理策略</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">ONE_DAY</span> <span class="operator">=</span> <span class="number">86400000L</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清理失效的EXCEL文件,异步建立的EXCEL导出任务文件如果由于其余某种原因未被清理</span></span><br><span class="line"><span class="comment"> * 则此处会每天清理一遍建立时间超过一天的EXCEL文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Scheduled(cron = &quot;0 0 0 ? * *&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanUpTheFailureExcelFile</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(SysConfigurationConsts.PUBLIC_EXPORT_DIR);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        BasicFileAttributes attr;</span><br><span class="line">        <span class="keyword">for</span> (File file : Objects.requireNonNull(f.listFiles())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;.xlsx&quot;</span>.equals(file.getName().substring(file.getName().length()-<span class="number">5</span>)))&#123;</span><br><span class="line">                attr = Files.readAttributes(Paths.get(file.getPath()), BasicFileAttributes.class);</span><br><span class="line">                <span class="type">Instant</span> <span class="variable">instant</span> <span class="operator">=</span> attr.creationTime().toInstant();</span><br><span class="line">                <span class="keyword">if</span> ((System.currentTimeMillis())- DateUtils.from(instant).getTime() &gt; ONE_DAY) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (file.delete()) &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;失效文件清理：&quot;</span>.concat(file.getName()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">        log.info(<span class="string">&quot;失效文件清理失败：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="2-0版本-与MybatisPlus结合的封装门面"><a href="#2-0版本-与MybatisPlus结合的封装门面" class="headerlink" title="2.0版本 - 与MybatisPlus结合的封装门面"></a>2.0版本 - 与MybatisPlus结合的封装门面</h1><blockquote>
<p>基于MybatisPlus与Apache包的封装，以门面模式简化导出工具使用</p>
</blockquote>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><p>利用MybatisPlus的自动分页参数配置来完成功能</p>
<p><strong>场景</strong></p>
<ol>
<li>普通的 N 条数据单页导出（N最好小于十万）</li>
<li>数据导出时按数据行进行合并单元格</li>
<li>大量数据导出，同一个Excel文件分多工作表进行写入</li>
<li>针对复杂巨型数据的游标与数据加工处理</li>
</ol>
<p><strong>全代码</strong></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/our99dreams/poi-async-example" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="依赖（POM）"><a href="#依赖（POM）" class="headerlink" title="依赖（POM）"></a>依赖（POM）</h2><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.73<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.CellType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义导出Excel数据注解</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> oursdreams</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Excel &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出到Excel中的名字.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BigDecimal 数据格式化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDecimalFormat</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">dateFormat</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出类型（0数字 1字符串）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CellType <span class="title function_">cellType</span><span class="params">()</span> <span class="keyword">default</span> CellType.STRING;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出时在excel中每个列的高度 单位为字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">double</span> <span class="title function_">height</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">14</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出时在excel中每个列的宽 单位为字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">double</span> <span class="title function_">width</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文字后缀,如% 90 变成90%</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">suffix</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当值为空时,字段的默认值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">defaultValue</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提示信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">prompt</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置只能选择不能输入的列内容.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] combo() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否导出数据,应对需求:有时我们需要导出一份模板,这是标题需要但内容需要用户手工填写.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isExport</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 另一个类中的属性名称,支持多级获取,以小数点隔开</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">targetAttr</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基准列标注，此基准列一般用以单元格合并的规则指定。注：合并仅为合并行，项目场景不对列进行操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">datum</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否按行合并</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">mergeRow</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段类型（0：导出导入；1：仅导出；2：仅导入）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Type <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> Type.ALL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Type</span> &#123;</span><br><span class="line">        <span class="comment">//导出导入</span></span><br><span class="line">        ALL(<span class="number">0</span>),</span><br><span class="line">        <span class="comment">//导出</span></span><br><span class="line">        EXPORT(<span class="number">1</span>),</span><br><span class="line">        <span class="comment">//导入</span></span><br><span class="line">        IMPORT(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        Type(<span class="type">int</span> value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">value</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Excel注解集</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> steven</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Excels &#123;</span><br><span class="line">    Excel[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="导出工具包（核心）"><a href="#导出工具包（核心）" class="headerlink" title="导出工具包（核心）"></a>导出工具包（核心）</h2><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.spring.annotation.Excel;</span><br><span class="line"><span class="keyword">import</span> com.spring.annotation.Excels;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFFont;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.util.HSSFColor;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.util.CellRangeAddress;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.util.CellRangeAddressList;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFDataValidation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实验多线程导出工具包</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/7/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelExportUtils</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MAX_EXPORT_COUNT</span> <span class="operator">=</span> <span class="number">50000</span>;<span class="comment">// 单页最大导出数量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">PUBLIC_EXPORT_DIR</span> <span class="operator">=</span> <span class="string">&quot;/share/storage/export/&quot;</span>;<span class="comment">// 默认的导出的目录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实体对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; clazz;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注解列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Field&gt; fields;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SXSSFWorkbook book;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelExportUtils</span><span class="params">(Class&lt;T&gt; clazz, String dir, String moduleName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(dir, moduleName);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.clazz = clazz;</span><br><span class="line">        <span class="built_in">this</span>.buildExcelField();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelExportUtils</span><span class="params">(String dir, String moduleName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.buildWorkBook();</span><br><span class="line">        <span class="built_in">this</span>.fileName = encodingFilename(moduleName);</span><br><span class="line">        <span class="built_in">this</span>.filePath = getAbsoluteFile(dir, fileName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编码文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encodingFilename</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        filename = filename + <span class="string">&quot;-&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;.xlsx&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回预期文件名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取下载路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename 文件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAbsoluteFile</span><span class="params">(String filePath, String filename)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">downloadPath</span> <span class="operator">=</span> filePath + filename;</span><br><span class="line">        <span class="type">File</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(downloadPath);</span><br><span class="line">        <span class="keyword">if</span> (!desc.getParentFile().exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!desc.getParentFile().mkdirs()) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;建立存储Excel目录失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> downloadPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildWorkBook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.book = <span class="keyword">new</span> <span class="title class_">SXSSFWorkbook</span>(MAX_EXPORT_COUNT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SXSSFSheet <span class="title function_">buildSheet</span><span class="params">(<span class="type">int</span> start)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> book.createSheet(((start * MAX_EXPORT_COUNT)+<span class="number">1</span>)+<span class="string">&quot;-&quot;</span>+((start+<span class="number">1</span>)* MAX_EXPORT_COUNT));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> SXSSFSheet <span class="title function_">buildSheet</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> book.createSheet(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">make</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath);</span><br><span class="line">            book.write(out);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;EXCEL文件生成失败:&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;EXCEL文件生成失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (book != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    book.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;EXCEL对象资源关闭失败:&#123;&#125;&quot;</span>,fileName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;EXCEL文件资源关闭失败:&#123;&#125;&quot;</span>,fileName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(List&lt;T&gt; list, SXSSFSheet sheet)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.build(list, sheet, fields);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(List&lt;T&gt; list, SXSSFSheet sheet, List&lt;Field&gt; fields)</span> &#123;</span><br><span class="line">        <span class="type">Write</span> <span class="variable">write</span> <span class="operator">=</span> <span class="built_in">this</span>.build(sheet, fields);</span><br><span class="line">        write.append(list);</span><br><span class="line">        write.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Write <span class="title function_">build</span><span class="params">(SXSSFSheet sheet, List&lt;Field&gt; fields)</span> &#123;</span><br><span class="line">        <span class="comment">// 标题行</span></span><br><span class="line">        <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">excelsNo</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 写入各个字段的列头名称</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">column</span> <span class="operator">=</span> <span class="number">0</span>; column &lt; fields.size(); column++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fields.get(column);</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excel.class)) &#123;</span><br><span class="line">                <span class="type">Excel</span> <span class="variable">excel</span> <span class="operator">=</span> field.getAnnotation(Excel.class);</span><br><span class="line">                createCell(sheet, excel, row, column);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excels.class)) &#123;</span><br><span class="line">                <span class="type">Excels</span> <span class="variable">attrs</span> <span class="operator">=</span> field.getAnnotation(Excels.class);</span><br><span class="line">                Excel[] excels = attrs.value();</span><br><span class="line">                <span class="comment">// 写入列名</span></span><br><span class="line">                <span class="type">Excel</span> <span class="variable">excel</span> <span class="operator">=</span> excels[excelsNo++];</span><br><span class="line">                createCell(sheet, excel, row, column);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">cs</span> <span class="operator">=</span> book.createCellStyle();</span><br><span class="line">        cs.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        cs.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        Excel[] excels = <span class="keyword">new</span> <span class="title class_">Excel</span>[fields.size()];</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">datum</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        List&lt;Integer&gt; mergeColumn = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">column</span> <span class="operator">=</span> <span class="number">0</span>; column &lt; fields.size(); column++) &#123;</span><br><span class="line">            <span class="comment">// 获得field.</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fields.get(column);</span><br><span class="line">            <span class="comment">// 设置实体类私有属性可访问</span></span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excel.class)) &#123;</span><br><span class="line">                excels[column] = field.getAnnotation(Excel.class);</span><br><span class="line">                <span class="keyword">if</span> (excels[column].datum()) &#123;</span><br><span class="line">                    datum = column;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (excels[column].mergeRow()) &#123;</span><br><span class="line">                    mergeColumn.add(column);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SlowSign</span> <span class="variable">slow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SlowSign</span>(mergeColumn, sheet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Write</span>(sheet, datum, excels, slow, cs, fields);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Write</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Sheet sheet;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Integer datum;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Excel[] excels;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SlowSign slow;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CellStyle cs;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Field&gt; fields;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">rowNum</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Write</span><span class="params">(Sheet sheet, Integer datum, Excel[] excels, SlowSign slow, CellStyle cs, List&lt;Field&gt; fields)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.sheet = sheet;</span><br><span class="line">            <span class="built_in">this</span>.datum = datum;</span><br><span class="line">            <span class="built_in">this</span>.excels = excels;</span><br><span class="line">            <span class="built_in">this</span>.slow = slow;</span><br><span class="line">            <span class="built_in">this</span>.cs = cs;</span><br><span class="line">            <span class="built_in">this</span>.fields = fields;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> rowNum - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">append</span><span class="params">(Object rowData)</span> &#123;</span><br><span class="line">            <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(rowNum);</span><br><span class="line">            <span class="comment">// 是否需要合并</span></span><br><span class="line">            <span class="keyword">if</span> (datum != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> String.valueOf(getTargetValue((T)rowData, fields.get(datum), excels[datum]));</span><br><span class="line">                    slow.merge(val, rowNum);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;导出Excel失败&#123;&#125;,&#123;&#125;&quot;</span>, e.getMessage(), JSONObject.toJSONString(e.getStackTrace()));</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">column</span> <span class="operator">=</span> <span class="number">0</span>; column &lt; fields.size(); column++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (excels[column] == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                addCell(excels[column], row, (T)rowData, fields.get(column), column, cs);</span><br><span class="line">            &#125;</span><br><span class="line">            rowNum++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">append</span><span class="params">(List&lt;?&gt; data)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Object rowData : data) &#123; <span class="built_in">this</span>.append(rowData); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (datum != <span class="literal">null</span>) &#123; slow.endMerge(); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Field&gt; <span class="title function_">buildExcelField</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        ArrayList&lt;Field&gt; fields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Field&gt; tempFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        tempFields.addAll(Arrays.asList(clazz.getSuperclass().getDeclaredFields()));</span><br><span class="line">        tempFields.addAll(Arrays.asList(clazz.getDeclaredFields()));</span><br><span class="line">        <span class="keyword">for</span> (Field field : tempFields) &#123;</span><br><span class="line">            <span class="comment">// 单注解</span></span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excel.class)) &#123;</span><br><span class="line">                <span class="type">Excel</span> <span class="variable">attr</span> <span class="operator">=</span> field.getAnnotation(Excel.class);</span><br><span class="line">                <span class="keyword">if</span> (attr != <span class="literal">null</span> &amp;&amp; (attr.type() == Excel.Type.ALL || attr.type() == Excel.Type.EXPORT)) &#123;</span><br><span class="line">                    fields.add(field);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 多注解</span></span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Excels.class)) &#123;</span><br><span class="line">                <span class="type">Excels</span> <span class="variable">attrs</span> <span class="operator">=</span> field.getAnnotation(Excels.class);</span><br><span class="line">                Excel[] excels = attrs.value();</span><br><span class="line">                <span class="keyword">for</span> (Excel excel : excels) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (excel != <span class="literal">null</span> &amp;&amp; (excel.type() == Excel.Type.ALL || excel.type() == Excel.Type.EXPORT)) &#123;</span><br><span class="line">                        fields.add(field);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildExcelField</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fields = <span class="built_in">this</span>.buildExcelField(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加单元格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCell</span><span class="params">(Excel attr, Row row, T vo, Field field, <span class="type">int</span> column, CellStyle cs)</span> &#123;</span><br><span class="line">        Cell cell;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置行高</span></span><br><span class="line">            row.setHeight((<span class="type">short</span>) (attr.height() * <span class="number">20</span>));</span><br><span class="line">            <span class="comment">// 根据Excel中设置情况决定是否导出,有些情况需要保持为空,希望用户填写这一列.</span></span><br><span class="line">            <span class="keyword">if</span> (attr.isExport()) &#123;</span><br><span class="line">                <span class="comment">// 创建cell</span></span><br><span class="line">                cell = row.createCell(column);</span><br><span class="line">                cell.setCellStyle(cs);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 用于读取对象中的属性</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getTargetValue(vo, field, attr);</span><br><span class="line">                <span class="type">String</span> <span class="variable">dateFormat</span> <span class="operator">=</span> attr.dateFormat();</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isDecimalFormat</span> <span class="operator">=</span> attr.isDecimalFormat();</span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">                    cell.setCellValue(<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(dateFormat).format((Date)value));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDecimalFormat) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        cell.setCellValue(<span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cell.setCellValue((<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(value.toString())).stripTrailingZeros().toPlainString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cell.setCellType(attr.cellType());</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        cell.setCellValue(attr.defaultValue());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (attr.cellType()) &#123;</span><br><span class="line">                            <span class="keyword">case</span> NUMERIC:</span><br><span class="line">                                cell.setCellValue(Double.parseDouble(String.valueOf(value)));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                cell.setCellValue(value + attr.suffix());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;导出Excel失败&#123;&#125;,&#123;&#125;&quot;</span>, e.getMessage(), JSONObject.toJSONString(e.getStackTrace()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取bean中的属性值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vo    实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field 字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> excel 注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 最终的属性值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getTargetValue</span><span class="params">(T vo, Field field, Excel excel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> field.get(vo);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(excel.targetAttr())) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> excel.targetAttr();</span><br><span class="line">            <span class="keyword">if</span> (target.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">                String[] targets = target.split(<span class="string">&quot;[.]&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String name : targets) &#123;</span><br><span class="line">                    o = getValue(o, name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                o = getValue(o, target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析导出值 0=男,1=女,2=未知</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> propertyValue 参数值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> converterExp  翻译注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解析后值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">convertByExp</span><span class="params">(String propertyValue, String converterExp)</span> &#123;</span><br><span class="line">        String[] convertSource = converterExp.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String item : convertSource) &#123;</span><br><span class="line">            String[] itemArray = item.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (itemArray[<span class="number">0</span>].equals(propertyValue)) &#123;</span><br><span class="line">                <span class="keyword">return</span> itemArray[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> propertyValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以类的属性的get方法方法形式获取值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o 属性对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 属性名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getValue</span><span class="params">(Object o, String name)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(name)) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = o.getClass();</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;get&quot;</span> + name.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + name.substring(<span class="number">1</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(methodName);</span><br><span class="line">            o = method.invoke(o);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建单元格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCell</span><span class="params">(Sheet sheet, Excel attr, Row row, <span class="type">int</span> column)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建列</span></span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> row.createCell(column);</span><br><span class="line">        <span class="comment">// 设置列中写入内容为String类型</span></span><br><span class="line">        cell.setCellType(CellType.STRING);</span><br><span class="line">        <span class="comment">// 写入列名</span></span><br><span class="line">        cell.setCellValue(attr.name());</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">cellStyle</span> <span class="operator">=</span> createStyle(sheet, attr, row, column);</span><br><span class="line">        cell.setCellStyle(cellStyle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建表格样式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CellStyle <span class="title function_">createStyle</span><span class="params">(Sheet sheet, Excel attr, Row row, <span class="type">int</span> column)</span> &#123;</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">cellStyle</span> <span class="operator">=</span> book.createCellStyle();</span><br><span class="line">        cellStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        cellStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> book.createFont();</span><br><span class="line">        <span class="keyword">if</span> (attr.name().contains(<span class="string">&quot;注：&quot;</span>)) &#123;</span><br><span class="line">            font.setColor(HSSFFont.COLOR_RED);</span><br><span class="line">            cellStyle.setFont(font);</span><br><span class="line">            cellStyle.setFillForegroundColor(HSSFColor.HSSFColorPredefined.YELLOW.getIndex());</span><br><span class="line">            sheet.setColumnWidth(column, <span class="number">6000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 粗体显示</span></span><br><span class="line">            font.setBold(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 选择需要用到的字体格式</span></span><br><span class="line">            cellStyle.setFont(font);</span><br><span class="line">            cellStyle.setFillForegroundColor(HSSFColor.HSSFColorPredefined.LIGHT_YELLOW.getIndex());</span><br><span class="line">            <span class="comment">// 设置列宽</span></span><br><span class="line">            sheet.setColumnWidth(column, (<span class="type">int</span>) ((attr.width() + <span class="number">0.72</span>) * <span class="number">256</span>));</span><br><span class="line">            row.setHeight((<span class="type">short</span>) (attr.height() * <span class="number">20</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">        cellStyle.setWrapText(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 如果设置了提示信息则鼠标放上去提示.</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(attr.prompt())) &#123;</span><br><span class="line">            <span class="comment">// 这里默认设了2-101列提示.</span></span><br><span class="line">            setXSSFPrompt(sheet, <span class="string">&quot;&quot;</span>, attr.prompt(), <span class="number">1</span>, <span class="number">100</span>, column, column);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果设置了combo属性则本列只能选择不能输入</span></span><br><span class="line">        <span class="keyword">if</span> (attr.combo().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里默认设了2-101列只能选择不能输入.</span></span><br><span class="line">            setXSSFValidation(sheet, attr.combo(), <span class="number">1</span>, <span class="number">100</span>, column, column);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cellStyle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置 POI XSSFSheet 单元格提示</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheet         表单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promptTitle   提示标题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promptContent 提示内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstRow      开始行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endRow        结束行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstCol      开始列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endCol        结束列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setXSSFPrompt</span><span class="params">(Sheet sheet, String promptTitle, String promptContent, <span class="type">int</span> firstRow, <span class="type">int</span> endRow,</span></span><br><span class="line"><span class="params">                              <span class="type">int</span> firstCol, <span class="type">int</span> endCol)</span> &#123;</span><br><span class="line">        <span class="type">DataValidationHelper</span> <span class="variable">helper</span> <span class="operator">=</span> sheet.getDataValidationHelper();</span><br><span class="line">        <span class="type">DataValidationConstraint</span> <span class="variable">constraint</span> <span class="operator">=</span> helper.createCustomConstraint(<span class="string">&quot;DD1&quot;</span>);</span><br><span class="line">        <span class="type">CellRangeAddressList</span> <span class="variable">regions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CellRangeAddressList</span>(firstRow, endRow, firstCol, endCol);</span><br><span class="line">        <span class="type">DataValidation</span> <span class="variable">dataValidation</span> <span class="operator">=</span> helper.createValidation(constraint, regions);</span><br><span class="line">        dataValidation.createPromptBox(promptTitle, promptContent);</span><br><span class="line">        dataValidation.setShowPromptBox(<span class="literal">true</span>);</span><br><span class="line">        sheet.addValidationData(dataValidation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置某些列的值只能输入预制的数据,显示下拉框.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheet    要设置的sheet.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textlist 下拉框显示的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstRow 开始行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endRow   结束行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstCol 开始列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endCol   结束列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setXSSFValidation</span><span class="params">(Sheet sheet, String[] textlist, <span class="type">int</span> firstRow, <span class="type">int</span> endRow, <span class="type">int</span> firstCol, <span class="type">int</span> endCol)</span> &#123;</span><br><span class="line">        <span class="type">DataValidationHelper</span> <span class="variable">helper</span> <span class="operator">=</span> sheet.getDataValidationHelper();</span><br><span class="line">        <span class="comment">// 加载下拉列表内容</span></span><br><span class="line">        <span class="type">DataValidationConstraint</span> <span class="variable">constraint</span> <span class="operator">=</span> helper.createExplicitListConstraint(textlist);</span><br><span class="line">        <span class="comment">// 设置数据有效性加载在哪个单元格上,四个参数分别是：起始行、终止行、起始列、终止列</span></span><br><span class="line">        <span class="type">CellRangeAddressList</span> <span class="variable">regions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CellRangeAddressList</span>(firstRow, endRow, firstCol, endCol);</span><br><span class="line">        <span class="comment">// 数据有效性对象</span></span><br><span class="line">        <span class="type">DataValidation</span> <span class="variable">dataValidation</span> <span class="operator">=</span> helper.createValidation(constraint, regions);</span><br><span class="line">        <span class="comment">// 处理Excel兼容性问题</span></span><br><span class="line">        <span class="keyword">if</span> (dataValidation <span class="keyword">instanceof</span> XSSFDataValidation) &#123;</span><br><span class="line">            dataValidation.setSuppressDropDownArrow(<span class="literal">true</span>);</span><br><span class="line">            dataValidation.setShowErrorBox(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dataValidation.setSuppressDropDownArrow(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sheet.addValidationData(dataValidation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SlowSign</span> &#123;</span><br><span class="line">        <span class="type">int</span> startRow;</span><br><span class="line">        String lastValue;</span><br><span class="line">        <span class="type">int</span> lastRow;</span><br><span class="line">        List&lt;Integer&gt; columns;</span><br><span class="line">        SXSSFSheet sheet;</span><br><span class="line">        SlowSign(List&lt;Integer&gt; columns, SXSSFSheet sheet) &#123;</span><br><span class="line">            <span class="built_in">this</span>.lastValue = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.columns = columns;</span><br><span class="line">            <span class="built_in">this</span>.sheet = sheet;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">merge</span><span class="params">(String value, <span class="type">int</span> row)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!lastValue.equals(value)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (startRow != lastRow) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.setMerge();</span><br><span class="line">                &#125;</span><br><span class="line">                lastValue = value == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : value;</span><br><span class="line">                startRow = row;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.lastRow = row;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">endMerge</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (startRow != lastRow) &#123;</span><br><span class="line">                <span class="built_in">this</span>.setMerge();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setMerge</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Integer column : columns) &#123;</span><br><span class="line">                <span class="type">CellRangeAddress</span> <span class="variable">mergeAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CellRangeAddress</span>(startRow, lastRow, column, column);</span><br><span class="line">                sheet.addMergedRegionUnsafe(mergeAddress);</span><br><span class="line">                <span class="comment">// 删除被合并cell,暂时不知道为什么设置addMergedRegionUnsafe不会清除所属cell，所以需要手动删除一下</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> startRow+<span class="number">1</span>; i &lt;= lastRow; i++) &#123;</span><br><span class="line">                    sheet.getRow(i).removeCell(sheet.getRow(i).getCell(column));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  Excel相关的任务缓存工具类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExcelTaskUtil</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">EXPIRE</span> <span class="operator">=</span> <span class="number">86500</span>;<span class="comment">// 过期时间</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * REDIS缓存KEY值</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> KEY值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> String <span class="title function_">USER_EXPORT_TASK</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;user:export:task:&quot;</span>.concat(String.valueOf(id));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 添加一个文件缓存任务</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> redisTemplate 缓存服务</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> countGroup 最大执行总量组</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addExportFile</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate, String fileName, Long id, <span class="type">int</span> countGroup)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(id);</span><br><span class="line">            <span class="keyword">if</span> (!redisTemplate.hasKey(key)) &#123;</span><br><span class="line">                redisTemplate.opsForHash().putAll(key, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            redisTemplate.opsForHash().put(key, fileName, <span class="string">&quot;0/&quot;</span>.concat(String.valueOf(countGroup)));</span><br><span class="line">            <span class="comment">// 文件一天过期，缓存信息一天过期 不过期也会被系统清理</span></span><br><span class="line">            redisTemplate.expire(key, EXPIRE, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行计划导出文件/片段执行结果</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> redisTemplate 缓存服务</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 任务是否全部执行完成</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">scheduleExportFile</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate, String fileName, Long id)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(id);</span><br><span class="line">            <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> (String)redisTemplate.opsForHash().get(key, fileName);</span><br><span class="line">            <span class="keyword">if</span> (val != <span class="literal">null</span>) &#123;</span><br><span class="line">                String[] arr = val.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> Integer.parseInt(arr[<span class="number">0</span>])+<span class="number">1</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> Integer.parseInt(arr[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                redisTemplate.opsForHash().put(key, fileName, current+<span class="string">&quot;/&quot;</span>+count);</span><br><span class="line">                <span class="comment">// 文件一天过期，缓存信息一天过期 不过期也会被系统清理</span></span><br><span class="line">                redisTemplate.expire(key, EXPIRE, TimeUnit.SECONDS);</span><br><span class="line">                <span class="keyword">return</span> current &gt;= count;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取用户下全部导出任务</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> redisTemplate 缓存服务</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 任务列表</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Object, Object&gt; <span class="title function_">getExportTask</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate, Long id)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(id);</span><br><span class="line">            <span class="keyword">if</span> (!redisTemplate.hasKey(key)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 验证任务是否存在</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> redisTemplate 缓存服务</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 验证结果</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verifyTaskExist</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate, String fileName, Long userId)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(userId);</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.hasKey(key) &amp;&amp; redisTemplate.opsForHash().hasKey(key, fileName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeCache</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate, String fileName, Long userId)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_EXPORT_TASK(userId);</span><br><span class="line">            redisTemplate.opsForHash().delete(key, fileName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="门面（调用入口）"><a href="#门面（调用入口）" class="headerlink" title="门面（调用入口）"></a>门面（调用入口）</h2><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.facade;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.spring.util.ExcelExportUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.TransactionTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 导出门面</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/6/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor_ = &#123;@Lazy, @Autowired&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportFacade</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolTaskExecutor poolTaskExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlatformTransactionManager dataSourceTransactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">pages</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// 初始总页数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> ExcelExportUtils.MAX_EXPORT_COUNT; <span class="comment">// 初始条数</span></span><br><span class="line">    <span class="keyword">public</span> ExportFacade <span class="title function_">setPages</span><span class="params">(<span class="type">int</span> pages)</span> &#123; <span class="built_in">this</span>.pages = pages; <span class="keyword">return</span> <span class="built_in">this</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> ExportFacade <span class="title function_">setSize</span><span class="params">(<span class="type">int</span> size)</span> &#123; <span class="built_in">this</span>.size = size; <span class="keyword">return</span> <span class="built_in">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">autoPages</span><span class="params">(DataProvider&lt;T&gt; dataService)</span> &#123;</span><br><span class="line">        Page&lt;T&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        page.setSearchCount(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> dataService.page(page).getTotal();</span><br><span class="line">        <span class="built_in">this</span>.pages = (<span class="type">int</span>)Math.ceil(((<span class="type">double</span>)total) / size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(String fileName, Class&lt;T&gt; clazz, DataProvider&lt;T&gt; dataService, <span class="type">long</span> userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.execute(fileName, clazz, dataService, <span class="literal">false</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(String fileName, Class&lt;T&gt; clazz, DataProvider&lt;T&gt; dataService, <span class="type">boolean</span> auto, <span class="type">long</span> userId)</span> &#123;</span><br><span class="line">        ExcelExportUtils&lt;T&gt; exportUtil = <span class="keyword">new</span> <span class="title class_">ExcelExportUtils</span>&lt;&gt;(clazz,</span><br><span class="line">                ExcelExportUtils.PUBLIC_EXPORT_DIR, fileName);</span><br><span class="line">        ExcelExportUtils.ExcelTaskUtil.addExportFile(redisService, exportUtil.getFileName(), userId, pages);</span><br><span class="line">        <span class="keyword">if</span> (auto) &#123;</span><br><span class="line">            <span class="built_in">this</span>.autoPages(dataService);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= pages; i++) &#123;</span><br><span class="line">            Page&lt;T&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(i, size);</span><br><span class="line">            page.setSearchCount(<span class="literal">false</span>);</span><br><span class="line">            poolTaskExecutor.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    List&lt;T&gt; list = dataService.page(page).getRecords();</span><br><span class="line">                    exportUtil.build(list, exportUtil.buildSheet((<span class="type">int</span>)(page.getCurrent() - <span class="number">1</span>)));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;线程池异常：&#123;&#125;,&#123;&#125;&quot;</span>, e.getMessage(),</span><br><span class="line">                            JSONObject.toJSONString(e.getStackTrace()));</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ExcelExportUtils.ExcelTaskUtil.scheduleExportFile(redisService, exportUtil.getFileName(), userId)) &#123;</span><br><span class="line">                        exportUtil.make();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ExportFacade <span class="title function_">setCursor</span><span class="params">(<span class="type">int</span> handlerSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.handlerSize = handlerSize;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">handlerSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游标处理-游标只有在事务中才会生效</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 目标类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataService 数据供给</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler 额外的分批处理器-游标数据每N条进行一次截片处理（可以用以拼接第三方数据）-可以使用setCursor来指定分片大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 目标对象-存在属性必须标注了Excel注解</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">cursor</span><span class="params">(String fileName, Class&lt;T&gt; clazz, CursorProvider&lt;T&gt; dataService, Consumer&lt;List&lt;T&gt;&gt; handler, <span class="type">long</span> userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个事务模板用默认的数据源事务管理器</span></span><br><span class="line">        <span class="type">TransactionTemplate</span> <span class="variable">transactionTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionTemplate</span>(dataSourceTransactionManager);</span><br><span class="line">        ExcelExportUtils&lt;T&gt; exportUtil = <span class="keyword">new</span> <span class="title class_">ExcelExportUtils</span>&lt;&gt;(ExcelExportUtils.PUBLIC_EXPORT_DIR, fileName);</span><br><span class="line"></span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">        poolTaskExecutor.execute(() -&gt; transactionTemplate.execute(action -&gt; &#123;</span><br><span class="line">            Cursor&lt;T&gt; cursor = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取页写入对象</span></span><br><span class="line">                AtomicReference&lt;ExcelExportUtils&lt;?&gt;.Write&gt; atomic = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">                ExcelExportUtils&lt;?&gt;.<span class="type">Write</span> <span class="variable">write</span> <span class="operator">=</span> exportUtil.build(exportUtil.buildSheet(<span class="string">&quot;第&quot;</span> + (i.get() + <span class="number">1</span>) + <span class="string">&quot;页&quot;</span>),</span><br><span class="line">                        exportUtil.buildExcelField(clazz));</span><br><span class="line">                atomic.set(write);</span><br><span class="line"></span><br><span class="line">                cursor = dataService.cursor();</span><br><span class="line">                <span class="comment">// 每收集一定条目进行一次处理</span></span><br><span class="line">                Consumer&lt;List&lt;T&gt;&gt; resultHandler = (data) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// TODO 对每批数据做一些额外的处理</span></span><br><span class="line">                        handler.accept(data);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (atomic.get().size() + data.size() &gt; size) &#123;</span><br><span class="line">                        atomic.get().close();</span><br><span class="line">                        i.getAndIncrement();</span><br><span class="line">                        atomic.set(exportUtil.build(exportUtil.buildSheet(<span class="string">&quot;第&quot;</span> + (i.get() + <span class="number">1</span>) + <span class="string">&quot;页&quot;</span>),</span><br><span class="line">                                exportUtil.buildExcelField(clazz)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    atomic.get().append(data);</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">// 分批处理游标数据，每收集一部分进行处理,这样是会多几次循环操作 但是可以保证职责单一与良好的隔离性</span></span><br><span class="line">                <span class="built_in">this</span>.handler(cursor, resultHandler, handlerSize);</span><br><span class="line">                write.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;数据导出失败：&#123;&#125;,堆栈信息：&#123;&#125;&quot;</span>, e.getMessage(), JSONObject.toJSON(e.getStackTrace()));</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cursor != <span class="literal">null</span>) &#123; cursor.close(); &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ignored) &#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (ExcelExportUtils.ExcelTaskUtil.scheduleExportFile(redisService, exportUtil.getFileName(), userId)) &#123;</span><br><span class="line">                    exportUtil.make();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(Cursor&lt;T&gt; cursor, Consumer&lt;List&lt;T&gt;&gt; handler, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        List&lt;T&gt; batch = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(size);</span><br><span class="line">        <span class="keyword">for</span> (T t : cursor) &#123;</span><br><span class="line">            batch.add(t);</span><br><span class="line">            <span class="keyword">if</span> (batch.size() == size) &#123;</span><br><span class="line">                handler.accept(batch);</span><br><span class="line">                batch.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!batch.isEmpty()) handler.accept(batch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DataProvider</span>&lt;T&gt; &#123;</span><br><span class="line">        Page&lt;T&gt; <span class="title function_">page</span><span class="params">(Page&lt;T&gt; page)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CursorProvider</span>&lt;T&gt; &#123;</span><br><span class="line">        Cursor&lt;T&gt; <span class="title function_">cursor</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.spring.facade.ExportFacade;</span><br><span class="line"><span class="keyword">import</span> com.spring.repository.entity.Test;</span><br><span class="line"><span class="keyword">import</span> com.spring.repository.service.ITestDataService;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor_ = &#123;@Lazy, @Autowired&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExportFacade exportFacade;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ITestDataService testDataService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolTaskExecutor poolTaskExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlatformTransactionManager dataSourceTransactionManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 普通用法-自动查询条数分页</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commonExport</span><span class="params">()</span> &#123;</span><br><span class="line">        exportFacade.execute(<span class="string">&quot;测试&quot;</span>, Test.class, testDataService::page, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 手动分页-禁止自动分页，手动指定查询数目与分页条数,默认情况下如果假定数据量不会超过初始值可以直接使用该方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pageExport</span><span class="params">()</span> &#123;</span><br><span class="line">        exportFacade.setPages(<span class="number">2</span>).setSize(<span class="number">1000</span>).execute(<span class="string">&quot;测试&quot;</span>, Test.class, testDataService::page, <span class="literal">false</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 游标用法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cursorExport</span><span class="params">()</span> &#123;</span><br><span class="line">        exportFacade.setCursor(<span class="number">2000</span>).cursor(<span class="string">&quot;测试&quot;</span>, Test.class, testDataService::cursor, items -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Test item : items) &#123;</span><br><span class="line">                item.setName(item.getName() + <span class="string">&quot;-游标的额外处理&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="游标子Mapper说明"><a href="#游标子Mapper说明" class="headerlink" title="游标子Mapper说明"></a>游标子Mapper说明</h3><blockquote>
<p>mapper接口中使用Cursor对象接收使用 @Options注解声明游标参数</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.repository.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.spring.repository.entity.Test;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Options;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ResultSetType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhendong Zhou</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TestMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Test&gt; &#123;</span><br><span class="line">    <span class="meta">@Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = Integer.MIN_VALUE)</span></span><br><span class="line">    Cursor&lt;Test&gt; <span class="title function_">cursor</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="文件获取与进度监听"><a href="#文件获取与进度监听" class="headerlink" title="文件获取与进度监听"></a>文件获取与进度监听</h2><p>见第一种方案的上述的 5，6步骤</p>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> Java基础POI的异步导出</li>
        <li><strong>作者:</strong> 不易</li>
        <li><strong>创建于
                :</strong> 2025-03-12 22:07:05</li>
        
            <li>
                <strong>更新于
                    :</strong> 2025-03-27 16:17:59
            </li>
        
        <li>
            <strong>链接:</strong> https://github.com/ourdreams0722/2025/03/12/大批量异步导出方案/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/java/">#java</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/03/12/%E6%88%91%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AA%E6%89%8B%E6%9C%BA%E5%8F%B7%E6%9D%A5%E7%94%A8%E4%B8%A4%E4%B8%AA%E5%BE%AE%E4%BF%A1/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">单号码多开微信</span>
						<span class="post-nav-item">上一篇</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/03/12/%E7%AE%97%E6%B3%95%E5%AE%9E%E8%B7%B5/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">简单算法-Java示例</span>
						<span class="post-nav-item">下一篇</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        评论
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          reaction: false,
          requiredMeta: ['nick', 'mail'],
          emoji: [],
          
          
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">目录</div>
		<div class="page-title">Java基础POI的异步导出</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#2-0%E7%89%88%E6%9C%AC-%E4%B8%8EMybatisPlus%E7%BB%93%E5%90%88%E7%9A%84%E5%B0%81%E8%A3%85%E9%97%A8%E9%9D%A2"><span class="nav-text">2.0版本 - 与MybatisPlus结合的封装门面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E6%8B%AC"><span class="nav-text">概括</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%EF%BC%88POM%EF%BC%89"><span class="nav-text">依赖（POM）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3"><span class="nav-text">注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%87%BA%E5%B7%A5%E5%85%B7%E5%8C%85%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="nav-text">导出工具包（核心）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%A8%E9%9D%A2%EF%BC%88%E8%B0%83%E7%94%A8%E5%85%A5%E5%8F%A3%EF%BC%89"><span class="nav-text">门面（调用入口）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">使用示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%B8%E6%A0%87%E5%AD%90Mapper%E8%AF%B4%E6%98%8E"><span class="nav-text">游标子Mapper说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%8E%B7%E5%8F%96%E4%B8%8E%E8%BF%9B%E5%BA%A6%E7%9B%91%E5%90%AC"><span class="nav-text">文件获取与进度监听</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2025</span>
              -
            
            2025<!--&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">不易</a>-->
            
        </div>
        
        <!--<div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span>
        </div>-->
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="站内搜索您需要的内容..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>


<script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/Swup.min.js" ></script><script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/SwupSlideTheme.min.js" ></script><script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/SwupScriptsPlugin.min.js" ></script><script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/SwupProgressPlugin.min.js" ></script><script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/SwupScrollPlugin.min.js" ></script><script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/SwupPreloadPlugin.min.js" ></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	<script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/imageViewer.js" ></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/utils.js" ></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/main.js" ></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/layouts/navbarShrink.js" ></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/scrollTopBottom.js" ></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/lightDarkSwitch.js" ></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/layouts/categoryList.js" ></script>


    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/localSearch.js" ></script>



    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/codeBlock.js" ></script>



    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/layouts/lazyload.js" ></script>



    <script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/runtime.js" ></script>
    <script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/odometer.min.js" ></script>
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/assets/odometer-theme-minimal.css">



  <script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/Typed.min.js" ></script>
  <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/plugins/typed.js" ></script>







    <script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/anime.min.js" ></script>




    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/tools/tocToggle.js" data-swup-reload-script></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/layouts/toc.js" data-swup-reload-script></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/plugins/tabs.js" data-swup-reload-script></script>


<script  src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/libs/moment-with-locales.min.js" data-swup-reload-script></script>
<script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.8.2/source/js/build/layouts/essays.js" data-swup-reload-script></script>




	
</body>

</html>